# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
orbs:
  aws-ecr: circleci/aws-ecr@8.1.3
  aws-ecs: circleci/aws-ecs@3.2.0

jobs:
  setup_environment:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    docker:
      - image: cimg/base:current
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - run:
          name: Setup environment
          command: |
            echo 'export TAG=0.1.${CIRCLE_BUILD_NUM}' >> $BASH_ENV
            

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_and_deploy:
    jobs:
      - setup_environment
      - aws-ecr/build-and-push-image:
          repo: skeletonarmy
          tag: ${TAG}
          path: server
          requires:
            - setup_environment
#      - aws-ecs/deploy-service-update:
#          cluster: 'bones'
#          container-image-name-updates: 'container=bones-server,tag=${TAG}'
#          family: 'bones-server'
#          service-name: 'bones-service'
#          requires:
#            - aws-ecr/build-and-push-image
